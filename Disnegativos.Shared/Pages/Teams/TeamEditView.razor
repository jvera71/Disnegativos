@using Disnegativos.Shared.DTOs
@using Disnegativos.Shared.Data.Entities
@using Disnegativos.Shared.Resources
@inject IStringLocalizer<SharedResources> L

<RadzenTabs RenderMode="TabRenderMode.Client">
    <Tabs>
        <RadzenTabsItem Text="@L["GeneralInfo"]" Icon="info">
            <RadzenTemplateForm TItem="TeamEditDto" Data="@Model" Submit="@OnSubmit">
                <RadzenStack Gap="1rem">
                    <RadzenRow>
                        <RadzenColumn Size="12" SizeMD="8">
                            <RadzenFormField Text="@L["Name"]" class="rz-w-100">
                                <RadzenTextBox @bind-Value="Model.Name" Name="Name" class="rz-w-100" />
                            </RadzenFormField>
                            <RadzenRequiredValidator Component="Name" Text="@L["RequiredField"]" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenFormField Text="@L["Alias"]" class="rz-w-100">
                                <RadzenTextBox @bind-Value="Model.Alias" class="rz-w-100" />
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>

                    <RadzenRow>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="@L["Discipline"]" class="rz-w-100">
                                <RadzenDropDown @bind-Value="Model.SportDisciplineId" Data="@Disciplines" TextProperty="NameKey" ValueProperty="Id" 
                                                class="rz-w-100" Name="Discipline" Change="@OnDisciplineChanged" />
                            </RadzenFormField>
                            <RadzenRequiredValidator Component="Discipline" Text="@L["RequiredField"]" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="@L["Category"]" class="rz-w-100">
                                <RadzenDropDown @bind-Value="Model.SportCategoryId" Data="@FilteredCategories" TextProperty="Name" ValueProperty="Id" 
                                                class="rz-w-100" Name="Category" Disabled="@(Model.SportDisciplineId == Guid.Empty)" />
                            </RadzenFormField>
                            <RadzenRequiredValidator Component="Category" Text="@L["RequiredField"]" />
                        </RadzenColumn>
                    </RadzenRow>

                    <RadzenRow>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="@L["ActivationDate"]" class="rz-w-100">
                                <RadzenDatePicker @bind-Value="Model.ActivationDate" class="rz-w-100" DateFormat="d" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" class="rz-h-100">
                                <RadzenCheckBox @bind-Value="Model.IsActive" Name="IsActive" />
                                <RadzenLabel Text="@L["Active"]" Component="IsActive" />
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>

                    <RadzenFormField Text="@L["Notes"]" class="rz-w-100">
                        <RadzenTextArea @bind-Value="Model.Notes" Rows="3" class="rz-w-100" />
                    </RadzenFormField>

                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" class="rz-mt-4">
                        <RadzenButton ButtonType="ButtonType.Button" Text="@L["Cancel"]" ButtonStyle="ButtonStyle.Light" Click="@OnCancel" />
                        <RadzenButton ButtonType="ButtonType.Submit" Text="@L["Save"]" ButtonStyle="ButtonStyle.Primary" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenTemplateForm>
        </RadzenTabsItem>
        
        <RadzenTabsItem Text="@L["Roster"]" Icon="group" Disabled="@(Model.Id == Guid.Empty)">
            <TeamPlayersView TeamId="@Model.Id" 
                             Data="@TeamPlayers" 
                             AvailablePlayers="@AvailablePlayers"
                             FieldPositions="@FieldPositions"
                             OnSavePlayer="@OnSavePlayer"
                             OnRemovePlayer="@OnRemovePlayer" />
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>

@code {
    [Parameter] public TeamEditDto Model { get; set; } = new();
    [Parameter] public List<SportDiscipline> Disciplines { get; set; } = [];
    [Parameter] public List<SportCategory> Categories { get; set; } = [];
    [Parameter] public List<TeamPlayerDto> TeamPlayers { get; set; } = [];
    [Parameter] public List<PlayerDto> AvailablePlayers { get; set; } = [];
    [Parameter] public List<FieldPosition> FieldPositions { get; set; } = [];
    
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<TeamEditDto> OnSubmit { get; set; }
    [Parameter] public EventCallback<TeamPlayerDto> OnSavePlayer { get; set; }
    [Parameter] public EventCallback<Guid> OnRemovePlayer { get; set; }

    private List<SportCategory> FilteredCategories => Categories
        .Where(c => c.SportDisciplineId == Model.SportDisciplineId)
        .ToList();

    private void OnDisciplineChanged(object value)
    {
        Model.SportCategoryId = Guid.Empty;
    }
}
